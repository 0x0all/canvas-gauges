/*

 HTML5 Canvas Gauge implementation

 This code is subject to MIT license.

 Copyright (c) 2012 Mykhailo Stadnyk <mikhus@gmail.com>

 Permission is hereby granted, free of charge, to any person obtaining a copy of
 this software and associated documentation files (the "Software"), to deal in
 the Software without restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the
 Software, and to permit persons to whom the Software is furnished to do so,
 subject to the following conditions:

 The above copyright notice and this permission notice shall be included in all
 copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 @authors: Mykhailo Stadnyk <mikhus@gmail.com>
           Chris Poile <poile@edwards.usask.ca>
           Luca Invernizzi <http://www.lucainvernizzi.net>
           Robert Blackburn <http://www.rwblackburn.com>
*/
var Gauge=function(B){Gauge.Collection.push(this);this.config={renderTo:null,width:200,height:200,title:false,maxValue:100,minValue:0,majorTicks:[],minorTicks:10,strokeTicks:true,units:false,valueFormat:{"int":3,dec:2},majorTicksFormat:{"int":1,dec:0},glow:true,animation:{delay:10,duration:250,fn:"cycle"},colors:{plate:"#fff",majorTicks:"#444",minorTicks:"#666",title:"#888",units:"#888",numbers:"#444",needle:{start:"rgba(240, 128, 128, 1)",end:"rgba(255, 160, 122, .9)",circle:{outerStart:"#f0f0f0",outerEnd:"#ccc",innerStart:"#e8e8e8",innerEnd:"#f5f5f5"},shadowUp:"rgba(2, 255, 255, 0.2)",shadowDown:"rgba(188, 143, 143, 0.45)"},valueBox:{rectStart:"#888",rectEnd:"#666",background:"#babab2",shadow:"rgba(0, 0, 0, 1)"},valueText:{foreground:"#444",shadow:"rgba(0, 0, 0, 0.3)"},circle:{shadow:"rgba(0, 0, 0, 0.5)",outerStart:"#ddd",outerEnd:"#aaa",middleStart:"#eee",middleEnd:"#f0f0f0",innerStart:"#fafafa",innerEnd:"#ccc"}},circles:{outerVisible:true,middleVisible:true,innerVisible:true},valueBox:{visible:true},valueText:{visible:true},highlights:[{from:20,to:60,color:"#eee"},{from:60,to:80,color:"#ccc"},{from:80,to:100,color:"#999"}]};var E=0,g=this,t=0,c=0,y=false;this.setValue=function(L){t=B.animation?E:L;var K=(B.maxValue-B.minValue)/100;c=L>B.maxValue?B.maxValue+K:L<B.minValue?B.minValue-K:L;E=L;B.animation?I():this.draw();return this};this.setRawValue=function(K){t=E=K;this.draw();return this};this.clear=function(){E=t=c=this.config.minValue;this.draw();return this};this.getValue=function(){return E};this.onready=function(){};function z(M,L){for(var K in L){if(typeof L[K]=="object"&&!(Object.prototype.toString.call(L[K])==="[object Array]")&&K!="renderTo"){if(typeof M[K]!="object"){M[K]={}}z(M[K],L[K])}else{M[K]=L[K]}}}z(this.config,B);this.config.minValue=parseFloat(this.config.minValue);this.config.maxValue=parseFloat(this.config.maxValue);B=this.config;t=E=B.minValue;if(!B.renderTo){throw Error("Canvas element was not specified when creating the Gauge object!")}var e=B.renderTo.tagName?B.renderTo:document.getElementById(B.renderTo),r=e.getContext("2d"),j,i,o,h,f,s,b;function p(){e.width=B.width;e.height=B.height;j=e.cloneNode(true);b=j.getContext("2d");i=e.width;o=e.height;h=i/2;f=o/2;s=h<f?h:f;j.i8d=false;b.translate(h,f);b.save();r.translate(h,f);r.save()}p();this.updateConfig=function(K){z(this.config,K);p();this.draw();return this};var C={linear:function(K){return K},quad:function(K){return Math.pow(K,2)},quint:function(K){return Math.pow(K,5)},cycle:function(K){return 1-Math.sin(Math.acos(K))},bounce:function(K){return 1-(function(N){for(var M=0,L=1;1;M+=L,L/=2){if(N>=(7-4*M)/11){return -Math.pow((11-6*M-11*N)/4,2)+Math.pow(L,2)}}})(1-K)},elastic:function(K){return 1-(function(M){var L=1.5;return Math.pow(2,10*(M-1))*Math.cos(20*Math.PI*L/3*M)})(1-K)}};var J=null;function l(K){var L=new Date;J=setInterval(function(){var M=new Date-L,N=M/K.duration;if(N>1){N=1}var O=typeof K.delta=="function"?K.delta:C[K.delta];var P=O(N);K.step(P);if(N==1){clearInterval(J)}},K.delay||10)}function I(){J&&clearInterval(J);var L=(c-t),M=t,K=B.animation;l({delay:K.delay,duration:K.duration,delta:K.fn,step:function(N){t=parseFloat(M)+L*N;g.draw()}})}r.lineCap="round";this.isWaitingForInitialization=false;this.drawWhenInitialized=function(){if(!Gauge.initialized){this.isWaitingForInitialization=true;return false}this.isWaitingForInitialization=false;w();q();if(!y){g.onready&&g.onready();y=true}return true};this.draw=function(){if(!j.i8d){b.clearRect(-h,-f,i,o);b.save();var K={ctx:r};r=b;v();k();a();m();G();x();H();j.i8d=true;r=K.ctx;delete K.ctx}r.clearRect(-h,-f,i,o);r.save();r.drawImage(j,-h,-f,i,o);this.drawWhenInitialized()};function D(K){return K*Math.PI/180}function F(M,L,K){var N=r.createLinearGradient(0,0,0,K);N.addColorStop(0,M);N.addColorStop(1,L);return N}function v(){var N=s/100*93,Q=s-N,M=s/100*91,P=s-M,L=s/100*88,O=s-L,K=s/100*85;r.save();if(B.glow){r.shadowBlur=Q;r.shadowColor=B.colors.circle.shadow}if(B.circles.outerVisible){r.beginPath();r.arc(0,0,N,0,Math.PI*2,true);r.fillStyle=F(B.colors.circle.outerStart,B.colors.circle.outerEnd,N);r.fill()}r.restore();if(B.circles.middleVisible){r.beginPath();r.arc(0,0,M,0,Math.PI*2,true);r.fillStyle=F(B.colors.circle.middleStart,B.colors.circle.middleEnd,M);r.fill()}if(B.circles.innerVisible){r.beginPath();r.arc(0,0,L,0,Math.PI*2,true);r.fillStyle=F(B.colors.circle.innerStart,B.colors.circle.innerEnd,L);r.fill()}r.beginPath();r.arc(0,0,K,0,Math.PI*2,true);r.fillStyle=B.colors.plate;r.fill();r.save()}function A(K){var M,L=false;if(B.majorTicksFormat.dec===0){M=Math.round(K).toString()}else{M=K.toFixed(B.majorTicksFormat.dec)}if(B.majorTicksFormat["int"]>1){L=(M.indexOf(".")>-1);if(M.indexOf("-")>-1){return"-"+[B.majorTicksFormat["int"]+B.majorTicksFormat.dec+2+(L?1:0)-M.length].join("0")+M.replace("-","")}else{return[B.majorTicksFormat["int"]+B.majorTicksFormat.dec+1+(L?1:0)-M.length].join("0")+M}}else{return M}}function m(){var N=s/100*81;r.lineWidth=2;r.strokeStyle=B.colors.majorTicks;r.save();if(B.majorTicks.length===0){var O=5;var M=(B.maxValue-B.minValue)/O;for(var L=0;L<O;L++){B.majorTicks.push(A(B.minValue+(M*L)))}B.majorTicks.push(A(B.maxValue))}for(var L=0;L<B.majorTicks.length;++L){var K=45+L*(270/(B.majorTicks.length-1));r.rotate(D(K));r.beginPath();r.moveTo(0,N);r.lineTo(0,N-s/100*15);r.stroke();r.restore();r.save()}if(B.strokeTicks){r.rotate(D(90));r.beginPath();r.arc(0,0,N,D(45),D(315),false);r.stroke();r.restore();r.save()}}function a(){var N=s/100*81;r.lineWidth=1;r.strokeStyle=B.colors.minorTicks;r.save();var K=B.minorTicks*(B.majorTicks.length-1);for(var M=0;M<K;++M){var L=45+M*(270/K);r.rotate(D(L));r.beginPath();r.moveTo(0,N);r.lineTo(0,N-s/100*7.5);r.stroke();r.restore();r.save()}}function G(){var M=s/100*55;for(var L=0;L<B.majorTicks.length;++L){var K=45+L*(270/(B.majorTicks.length-1)),N=u(M,D(K));r.font=20*(s/200)+"px Arial";r.fillStyle=B.colors.numbers;r.lineWidth=0;r.textAlign="center";r.fillText(B.majorTicks[L],N.x,N.y+3)}}function x(){if(!B.title){return}r.save();r.font=24*(s/200)+"px Arial";r.fillStyle=B.colors.title;r.textAlign="center";r.fillText(B.title,0,-s/4.25);r.restore()}function H(){if(!B.units){return}r.save();r.font=22*(s/200)+"px Arial";r.fillStyle=B.colors.units;r.textAlign="center";r.fillText(B.units,0,s/3.25);r.restore()}function d(N){var P=B.valueFormat.dec,K=B.valueFormat["int"];N=parseFloat(N);var O=(N<0);N=Math.abs(N);if(P>0){N=N.toFixed(P).toString().split(".");for(var L=0,M=K-N[0].length;L<M;++L){N[0]="0"+N[0]}N=(O?"-":"")+N[0]+"."+N[1]}else{N=Math.round(N).toString();for(var L=0,M=K-N.length;L<M;++L){N="0"+N}N=(O?"-":"")+N}return N}function u(N,L){var K=0,R=N,M=Math.sin(L),O=Math.cos(L),Q=K*O-R*M,P=K*M+R*O;return{x:Q,y:P}}function k(){r.save();var O=s/100*81;var M=O-s/100*15;for(var P=0,U=B.highlights.length;P<U;P++){var V=B.highlights[P],Q=(B.maxValue-B.minValue)/270,T=D(45+(V.from-B.minValue)/Q),S=D(45+(V.to-B.minValue)/Q);r.beginPath();r.rotate(D(90));r.arc(0,0,O,T,S,false);r.restore();r.save();var K=u(M,T),R=u(O,T);r.moveTo(K.x,K.y);r.lineTo(R.x,R.y);var N=u(O,S),L=u(M,S);r.lineTo(N.x,N.y);r.lineTo(L.x,L.y);r.lineTo(K.x,K.y);r.closePath();r.fillStyle=V.color;r.fill();r.beginPath();r.rotate(D(90));r.arc(0,0,M,T-0.2,S+0.2,false);r.restore();r.closePath();r.fillStyle=B.colors.plate;r.fill();r.save()}}function q(){var L=s/100*12,K=s/100*8,O=s/100*77,Q=s/100*20,P=s/100*4,N=s/100*2,M=function(){r.shadowOffsetX=2;r.shadowOffsetY=2;r.shadowBlur=10;r.shadowColor=B.colors.needle.shadowDown};M();r.save();if(t<0){t=Math.abs(B.minValue-t)}else{if(B.minValue>0){t-=B.minValue}else{t=Math.abs(B.minValue)+t}}r.rotate(D(45+t/((B.maxValue-B.minValue)/270)));r.beginPath();r.moveTo(-N,-Q);r.lineTo(-P,0);r.lineTo(-1,O);r.lineTo(1,O);r.lineTo(P,0);r.lineTo(N,-Q);r.closePath();r.fillStyle=F(B.colors.needle.start,B.colors.needle.end,O-Q);r.fill();r.beginPath();r.lineTo(-0.5,O);r.lineTo(-1,O);r.lineTo(-P,0);r.lineTo(-N,-Q);r.lineTo(N/2-2,-Q);r.closePath();r.fillStyle=B.colors.needle.shadowUp;r.fill();r.restore();M();r.beginPath();r.arc(0,0,L,0,Math.PI*2,true);r.fillStyle=F(B.colors.needle.circle.outerStart,B.colors.needle.circle.outerEnd,L);r.fill();r.restore();r.beginPath();r.arc(0,0,K,0,Math.PI*2,true);r.fillStyle=F(B.colors.needle.circle.innerStart,B.colors.needle.circle.innerEnd,K);r.fill()}function n(K,O,L,M,N){r.beginPath();r.moveTo(K+N,O);r.lineTo(K+L-N,O);r.quadraticCurveTo(K+L,O,K+L,O+N);r.lineTo(K+L,O+M-N);r.quadraticCurveTo(K+L,O+M,K+L-N,O+M);r.lineTo(K+N,O+M);r.quadraticCurveTo(K,O+M,K,O+M-N);r.lineTo(K,O+N);r.quadraticCurveTo(K,O,K+N,O);r.closePath()}function w(){if(!B.valueText.visible){return}r.save();r.font=40*(s/200)+"px Led";var O=d(E),P=s-s/100*33,K=0;r.save();if(B.valueBox.visible){var N=0.12*s,M=r.measureText("-"+d(0)).width;n(-M/2-0.025*s,P-N-0.04*s,M+0.05*s,N+0.07*s,0.025*s)}var L=r.createRadialGradient(K,P-0.12*s-0.025*s+(0.12*s+0.045*s)/2,s/10,K,P-0.12*s-0.025*s+(0.12*s+0.045*s)/2,s/5);L.addColorStop(0,B.colors.valueBox.rectStart);L.addColorStop(1,B.colors.valueBox.rectEnd);r.strokeStyle=L;r.lineWidth=0.05*s;r.stroke();r.shadowBlur=0.012*s;r.shadowColor=B.colors.valueBox.shadow;r.fillStyle=B.colors.valueBox.background;r.fill();r.restore();r.shadowOffsetX=0.004*s;r.shadowOffsetY=0.004*s;r.shadowBlur=0.012*s;r.shadowColor=B.colors.valueText.shadow;r.fillStyle=B.colors.valueText.foreground;r.textAlign="center";r.fillText(O,-K,P);r.restore()}};Gauge.initialized=false;(function(){var g=document,f=navigator.userAgent.toLocaleLowerCase().indexOf("msie")!=-1,e="url('fonts/digital-7-mono."+(f?"eot":"ttf")+"')",b="Led";function c(){Gauge.initialized=true;for(var d=0;d<Gauge.Collection.length;++d){if(Gauge.Collection[d].isWaitingForInitialization){Gauge.Collection[d].drawWhenInitialized()}}}function a(){var j=g.getElementsByTagName("head")[0],m="@font-face { font-family: '"+b+"'; src: "+e+"; }",i,k=g.createElement("style");k.type="text/css";if(f){j.appendChild(k);i=k.styleSheet;i.cssText=m}else{try{k.appendChild(g.createTextNode(m))}catch(l){k.cssText=m}j.appendChild(k);i=k.styleSheet?k.styleSheet:(k.sheet||g.styleSheets[g.styleSheets.length-1])}var d=setInterval(function(){if(!g.body){return}clearInterval(d);var n=g.createElement("div");n.style.fontFamily=b;n.style.position="absolute";n.style.height=n.style.width=0;n.style.overflow="hidden";n.innerHTML=".";g.body.appendChild(n);setTimeout(function(){c();n.parentNode.removeChild(n)},250)},1)}if(document.fonts===undefined){a()}else{var h=new window.FontFace(b,e);document.fonts.add(h);h.load().then(function(d){c()},function(d){if(window.console){window.console.log(d)}a()})}})();Gauge.Collection=[];Gauge.Collection.get=function(e){var a=this;if(typeof(e)=="string"){for(var c=0,d=a.length;c<d;c++){var b=a[c].config.renderTo.tagName?a[c].config.renderTo:document.getElementById(a[c].config.renderTo);if(b.getAttribute("id")==e){return a[c]}}}else{if(typeof(e)=="number"){return a[e]}else{return null}}};function domReady(a){if(window.addEventListener){window.addEventListener("DOMContentLoaded",a,false)}else{window.attachEvent("onload",a)}}domReady(function(){function toCamelCase(arr){var str=arr[0];for(var i=1,s=arr.length;i<s;i++){str+=arr[i].substr(0,1).toUpperCase()+arr[i].substr(1,arr[i].length-1)}return str}function trim(str){return str.replace(/^\s+|\s+$/g,"")}var c=document.getElementsByTagName("canvas");for(var i=0,s=c.length;i<s;i++){if(c[i].getAttribute("data-type")=="canv-gauge"){var gauge=c[i],config={},prop,w=parseInt(gauge.getAttribute("width"),10),h=parseInt(gauge.getAttribute("height"),10);config.renderTo=gauge;if(w){config.width=w}if(h){config.height=h}for(var ii=0,ss=gauge.attributes.length;ii<ss;ii++){prop=gauge.attributes.item(ii).nodeName;if(prop!="data-type"&&prop.substr(0,5)=="data-"){var cfgProp=prop.substr(5,prop.length-5).toLowerCase().split("-"),attrValue=gauge.getAttribute(prop);if(!attrValue){continue}switch(cfgProp[0]){case"colors":if(cfgProp[1]){if(!config.colors){config.colors={}}if(!config.colors.needle){config.colors.needle={}}if(cfgProp[1]=="needle"){if(!cfgProp[2]){var parts=attrValue.split(/\s+/);if(parts[0]&&parts[1]){config.colors.needle.start=parts[0];config.colors.needle.end=parts[1]}else{config.colors.needle.start=attrValue}}else{switch(cfgProp[2]){case"start":config.colors.needle.start=attrValue;break;case"end":config.colors.needle.end=attrValue;break}}if(cfgProp[2]){if(!config.colors.needle.circle){config.colors.needle.circle={}}switch(cfgProp[2]){case"circle":switch(cfgProp[3]){case"outerstart":config.colors.needle.circle.outerStart=attrValue;break;case"outerend":config.colors.needle.circle.outerEnd=attrValue;break;case"innerstart":config.colors.needle.circle.innerStart=attrValue;break;case"innerend":config.colors.needle.circle.innerEnd=attrValue;break}case"shadowup":config.colors.needle.shadowUp=attrValue;break;case"shadowdown":config.colors.needle.shadowDown=attrValue;break}}}else{if(cfgProp[1]=="valuebox"){if(!config.colors.valueBox){config.colors.valueBox={}}if(cfgProp[2]){switch(cfgProp[2]){case"rectstart":config.colors.valueBox.rectStart=attrValue;break;case"rectend":config.colors.valueBox.rectEnd=attrValue;break;case"background":config.colors.valueBox.background=attrValue;break;case"shadow":config.colors.valueBox.shadow=attrValue;break}}}else{if(cfgProp[1]=="valuetext"){if(!config.colors.valueText){config.colors.valueText={}}if(cfgProp[2]){switch(cfgProp[2]){case"foreground":config.colors.valueText.foreground=attrValue;break;case"shadow":config.colors.valueText.shadow=attrValue;break}}}else{if(cfgProp[1]=="circle"){if(!config.colors.circle){config.colors.circle={}}if(cfgProp[2]){switch(cfgProp[2]){case"shadow":config.colors.circle.shadow=attrValue;break;case"outerstart":config.colors.circle.outerStart=attrValue;break;case"outerend":config.colors.circle.outerEnd=attrValue;break;case"middlestart":config.colors.circle.middleStart=attrValue;break;case"middleend":config.colors.circle.middleEnd=attrValue;break;case"innerstart":config.colors.circle.innerStart=attrValue;break;case"innerend":config.colors.circle.innerEnd=attrValue;break}}}else{cfgProp.shift();config.colors[toCamelCase(cfgProp)]=attrValue}}}}}break;case"circles":if(!config.circles){config.circles={}}if(cfgProp[1]){switch(cfgProp[1]){case"outervisible":config.circles.outerVisible=attrValue.toLowerCase()==="true";break;case"middlevisible":config.circles.middleVisible=attrValue.toLowerCase()==="true";break;case"innervisible":config.circles.innerVisible=attrValue.toLowerCase()==="true";break}}break;case"valuebox":if(!config.valueBox){config.valueBox={}}if(cfgProp[1]){switch(cfgProp[1]){case"visible":config.valueBox.visible=attrValue.toLowerCase()==="true";break}}break;case"valuetext":if(!config.valueText){config.valueText={}}if(cfgProp[1]){switch(cfgProp[1]){case"visible":config.valueText.visible=attrValue.toLowerCase()==="true";break}}break;case"highlights":if(!config.highlights){config.highlights=[]}var hls=attrValue.match(/(?:(?:-?\d*\.)?(-?\d+){1,2} ){2}(?:(?:#|0x)?(?:[0-9A-F|a-f]){3,8}|rgba?\(.*?\))/g);for(var j=0,l=hls.length;j<l;j++){var cfg=trim(hls[j]).split(/\s+/),hlCfg={};if(cfg[0]&&cfg[0]!=""){hlCfg.from=cfg[0]}if(cfg[1]&&cfg[1]!=""){hlCfg.to=cfg[1]}if(cfg[2]&&cfg[2]!=""){hlCfg.color=cfg[2]}config.highlights.push(hlCfg)}break;case"animation":if(cfgProp[1]){if(!config.animation){config.animation={}}if(cfgProp[1]=="fn"&&/^\s*function\s*\(/.test(attrValue)){attrValue=eval("("+attrValue+")")}config.animation[cfgProp[1]]=attrValue}break;default:var cfgName=toCamelCase(cfgProp);if(cfgName=="onready"){continue}if(cfgName=="majorTicks"){attrValue=attrValue.split(/\s+/)}else{if(cfgName=="strokeTicks"||cfgName=="glow"){attrValue=attrValue=="true"?true:false}else{if(cfgName=="valueFormat"){var val=attrValue.split(".");if(val.length==2){attrValue={"int":parseInt(val[0],10),dec:parseInt(val[1],10)}}else{continue}}}}config[cfgName]=attrValue;break}}}var g=new Gauge(config);if(gauge.getAttribute("data-value")){g.setRawValue(parseFloat(gauge.getAttribute("data-value")))}if(gauge.getAttribute("data-onready")){g.onready=function(){eval(this.config.renderTo.getAttribute("data-onready"))}}g.draw()}}});window.Gauge=Gauge;